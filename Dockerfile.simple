FROM node:20-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user
ARG USER_UID=1001
ARG USER_GID=1001
RUN groupadd -g $USER_GID claude-user && \
    useradd -m -s /bin/bash -u $USER_UID -g claude-user claude-user && \
    echo "claude-user ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Install Claude Code globally
RUN npm install -g @anthropic-ai/claude-code

# Create directories
RUN mkdir -p /home/claude-user/.claude

# Copy authentication files
COPY .claude.json /home/claude-user/.claude.json
COPY .claude/.credentials.json /home/claude-user/.claude/.credentials.json

# Set ownership
RUN chown -R claude-user:claude-user /home/claude-user

# Switch to non-root user
USER claude-user
WORKDIR /workspace

# Default command
CMD ["claude", "--help"]